<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Faith Journey</title>
  
  <!-- Premium Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    :root {
      /* --- COLORS & THEME --- */
      --bg-body: #F3F4F6;
      --bg-card: #FFFFFF;
      --bg-nav-mobile: rgba(255, 255, 255, 0.95);
      --bg-subtle: #F9FAFB;
      
      --primary: #6366f1;
      --primary-dim: rgba(99, 102, 241, 0.15);
      --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      
      --text-main: #1F2937;
      --text-muted: #6B7280;
      
      --border: #E5E7EB;
      
      --success: #10B981;
      --danger: #EF4444;
      --danger-bg: #FEE2E2;

      /* Shadows & Radius */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-nav: 0 -4px 20px rgba(0,0,0,0.05);
      
      --radius: 20px;
    }

    [data-theme="dark"] {
      --bg-body: #0F172A;
      --bg-card: #1E293B;
      --bg-nav-mobile: rgba(30, 41, 59, 0.95);
      --bg-subtle: #334155;
      
      --primary: #818cf8;
      --primary-dim: rgba(129, 140, 248, 0.2);
      
      --text-main: #F9FAFB;
      --text-muted: #94A3B8;
      
      --border: #334155;
      
      --success: #34D399;
      --danger: #F87171;
      --danger-bg: rgba(220, 38, 38, 0.2);
      
      --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      --shadow-nav: 0 -4px 20px rgba(0,0,0,0.3);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      font-family: 'Plus Jakarta Sans', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 90px;
      transition: background-color 0.4s ease, color 0.4s ease;
    }

    /* --- HEADER --- */
    header {
      background: var(--bg-nav-mobile);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .header-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 38px; height: 38px;
      background: var(--accent-gradient);
      color: white;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .brand h1 { font-family: 'Outfit', sans-serif; font-size: 1.25rem; font-weight: 700; }

    .header-actions { display: flex; gap: 10px; }
    .btn-icon {
      width: 38px; height: 38px; border-radius: 50%; border: 1px solid var(--border);
      background: var(--bg-card); color: var(--text-main);
      display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
      cursor: pointer; transition: 0.2s;
    }
    .btn-icon:hover { background: var(--bg-subtle); transform: scale(1.05); }


    /* --- MAIN CONTENT WRAPPER --- */
    main {
      flex: 1; 
      max-width: 800px; 
      width: 100%; 
      margin: 0 auto; 
      padding: 20px;
      display: flex; 
      flex-direction: column; 
      gap: 24px;
    }


    /* --- HYBRID NAVIGATION --- */
    
    .nav-wrapper {
      /* Mobile Default: Fixed Bottom */
      position: fixed;
      bottom: 0; left: 0; width: 100%;
      background: var(--bg-nav-mobile);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: var(--shadow-nav);
    }

    .nav-container {
      /* Mobile: Distributed Flex */
      display: flex;
      justify-content: space-around;
      padding: 8px 10px;
      max-width: 800px;
      margin: 0 auto;
    }

    .nav-btn {
      /* Mobile: Icon top, text bottom */
      background: transparent; border: none;
      color: var(--text-muted);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 4px; padding: 6px; flex: 1;
      font-size: 0.7rem; font-weight: 600;
      cursor: pointer; transition: 0.2s; border-radius: 12px;
    }
    
    .nav-btn i { font-size: 1.5rem; transition: 0.2s; }
    .nav-btn.active { color: var(--primary); }
    .nav-btn.active i { transform: translateY(-2px); font-weight: bold; }

    /* --- DESKTOP / TABLET FIX --- */
    @media (min-width: 768px) {
      body { padding-bottom: 40px; }

      .nav-wrapper {
        position: static; 
        background: transparent;
        border: none;
        box-shadow: none;
        padding: 0;
        margin-bottom: 0;
        z-index: 1;
      }

      .nav-container {
        display: flex;
        justify-content: center; /* Center aligned */
        gap: 12px;
        padding: 10px 0; /* Padding to prevent clipping on active state */
        overflow: visible; 
      }

      .nav-btn {
        flex: 0 0 auto;
        flex-direction: row;
        background: var(--bg-card);
        border: 1px solid var(--border);
        padding: 10px 24px;
        border-radius: 99px;
        font-size: 0.9rem;
        color: var(--text-muted);
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      }

      .nav-btn i { font-size: 1.1rem; margin: 0; transform: none !important; }
      
      .nav-btn:hover {
        background: var(--bg-subtle);
        color: var(--primary);
        border-color: var(--primary);
      }

      .nav-btn.active {
        background: var(--text-main);
        color: var(--bg-body);
        border-color: var(--text-main);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateY(-2px);
      }
      
      [data-theme="dark"] .nav-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
      }
    }

    /* --- GENERAL CSS --- */
    @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .section { display: none; animation: fadeUp 0.4s ease; grid-template-columns: 1fr; gap: 24px; }
    .section.active { display: grid; }

    .card {
      background: var(--bg-card); border-radius: var(--radius); padding: 24px;
      box-shadow: var(--shadow-card); border: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 16px; transition: transform 0.2s;
    }
    @media (min-width: 768px) { .card:hover { transform: translateY(-2px); } }

    .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .card-title { font-family: 'Outfit', sans-serif; font-size: 1.2rem; font-weight: 700; color: var(--text-main); }
    .card-subtitle { font-size: 0.9rem; color: var(--text-muted); margin-top: 2px; }

    .pill {
      font-size: 0.75rem; font-weight: 700; text-transform: uppercase; padding: 6px 12px;
      border-radius: 8px; background: var(--bg-subtle); color: var(--text-muted); letter-spacing: 0.5px;
    }

    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .stat-box {
      background: var(--bg-subtle); border-radius: 16px; padding: 16px; text-align: center;
      border: 1px solid transparent;
    }
    .stat-value { font-family: 'Outfit', sans-serif; font-size: 1.8rem; font-weight: 800; color: var(--primary); line-height: 1.2; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; margin-top: 4px; }

    .progress-bg { height: 10px; background: var(--bg-subtle); border-radius: 99px; overflow: hidden; margin-top: 8px; border: 1px solid var(--border); }
    .progress-fill { height: 100%; background: var(--accent-gradient); width: 0%; transition: width 0.8s ease; }

    .mission {
      display: flex; align-items: center; justify-content: space-between;
      background: var(--bg-subtle); padding: 16px; border-radius: 16px; margin-bottom: 12px;
      border: 1px solid transparent; transition: 0.2s;
    }
    .mission:hover { background: var(--bg-card); border-color: var(--border); }
    
    .btn-check {
      width: 36px; height: 36px; border-radius: 12px; border: 2px solid var(--border);
      background: var(--bg-card); display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; color: transparent; cursor: pointer; transition: 0.2s;
    }
    .btn-check.completed { background: var(--success); border-color: var(--success); color: white; transform: scale(1.1); }

    input, select, textarea {
      width: 100%; padding: 14px; border-radius: 14px; border: 1px solid var(--border);
      background: var(--bg-subtle); color: var(--text-main); outline: none;
      font-family: inherit; font-size: 0.95rem; transition: 0.2s;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); background: var(--bg-card); box-shadow: 0 0 0 3px var(--primary-dim); }

    .btn {
      border: none; padding: 14px; border-radius: 14px; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem;
      transition: 0.2s;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--text-main); color: var(--bg-body); }
    [data-theme="dark"] .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg-subtle); }
    .btn-accent { background: var(--accent-gradient); color: white; }
    .btn-danger { background: var(--danger-bg); color: var(--danger); }
    .btn-whatsapp { background: #25D366; color: white; font-weight: 700; box-shadow: 0 4px 10px rgba(37,211,102,0.3); }

    .timer-display { font-family: 'Outfit', sans-serif; font-size: 4rem; font-weight: 800; text-align: center; margin: 24px 0; letter-spacing: -2px; }

    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
      z-index: 200; display: none; align-items: center; justify-content: center; padding: 20px;
    }
    .modal-backdrop.show { display: flex; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .modal {
      background: var(--bg-card); width: 100%; max-width: 400px; border-radius: 24px; padding: 24px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2); border: 1px solid var(--border);
    }

    .chip-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .chip {
      background: var(--bg-subtle); border: 1px solid var(--border); padding: 8px 14px;
      border-radius: 10px; font-size: 0.85rem; color: var(--text-muted); cursor: pointer; transition: 0.2s;
    }
    .chip.selected { background: var(--primary); color: white; border-color: var(--primary); }

  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="header-content">
      <div class="brand">
        <div class="logo-icon"><i class="ph-bold ph-cross"></i></div>
        <h1>Faith Journey</h1>
      </div>
      <div class="header-actions">
        <button class="btn-icon" id="theme-toggle"><i class="ph ph-moon"></i></button>
        <button class="btn-icon" id="btn-open-onboarding"><i class="ph ph-gear"></i></button>
      </div>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main>
    
    <!-- NAVIGATION -->
    <nav class="nav-wrapper">
      <div class="nav-container">
        <button class="nav-btn active" data-section="dashboard">
          <i class="ph ph-house"></i>
          <span>Home</span>
        </button>
        <button class="nav-btn" data-section="missions">
          <i class="ph ph-check-circle"></i>
          <span>Missions</span>
        </button>
        <button class="nav-btn" data-section="timer">
          <i class="ph ph-hourglass"></i>
          <span>Timer</span>
        </button>
        <button class="nav-btn" data-section="reflections">
          <i class="ph ph-notebook"></i>
          <span>Journal</span>
        </button>
        <button class="nav-btn" data-section="profile">
          <i class="ph ph-user"></i>
          <span>Profile</span>
        </button>
      </div>
    </nav>

    <!-- DASHBOARD -->
    <section class="section active" id="section-dashboard">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Hello, <span id="level-name">Pilgrim</span></div>
            <div class="card-subtitle">Your journey today.</div>
          </div>
          <div class="pill" id="today-label">Today</div>
        </div>

        <div class="stats-grid">
           <div class="stat-box">
             <span class="stat-value" id="streak-days">0</span>
             <span class="stat-label">Day Streak ðŸ”¥</span>
           </div>
           <div class="stat-box">
             <span class="stat-value" id="xp-total">0</span>
             <span class="stat-label">Total XP</span>
           </div>
        </div>

        <div style="margin-top:4px;">
          <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:var(--text-muted); margin-bottom:4px; font-weight:600;">
             <span>Level <span id="header-level">1</span></span>
             <span id="next-level-label">0/100 XP</span>
          </div>
          <div class="progress-bg">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">ðŸ’¡ Today's Focus</div>
          <div class="pill" id="profile-focus-pill">General</div>
        </div>
        <p id="today-suggestion" style="font-size: 0.95rem; color: var(--text-muted); line-height: 1.5;">...</p>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">ðŸ“Š Daily Summary</div></div>
        <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--border);">
          <span style="color:var(--text-muted)">Completed Missions</span> <strong id="missions-today" style="color:var(--text-main)">0/5</strong>
        </div>
        <div style="display:flex; justify-content:space-between; padding:12px 0;">
          <span style="color:var(--text-muted)">Journal Entries</span> <strong id="reflections-count" style="color:var(--text-main)">0</strong>
        </div>
      </div>
    </section>

    <!-- MISSIONS -->
    <section class="section" id="section-missions">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Daily Missions</div>
          <div class="pill">XP</div>
        </div>
        <div id="missions-list"></div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">ðŸŽ¯ Purpose</div></div>
        <select id="purpose-select" style="margin-bottom:12px;">
          <option value="">No purpose defined</option>
          <option value="7">7 Days with God</option>
          <option value="21">Daniel Fast (21 days)</option>
          <option value="30">30 Days of Proverbs</option>
        </select>
        <textarea id="purpose-notes" placeholder="Your personal goal..." rows="3"></textarea>
        <button class="btn btn-secondary" style="width:100%; margin-top:12px;" id="btn-save-purpose">Save Purpose</button>
      </div>
    </section>

    <!-- TIMER -->
    <section class="section" id="section-timer">
      <div class="card" style="text-align:center; padding: 40px 24px;">
        <div class="pill" style="display:inline-block; margin-bottom:10px;" id="timer-status-pill">Ready</div>
        <div class="timer-display" id="timer-display">00:00</div>
        <p style="color:var(--text-muted); margin-bottom:30px; font-style:italic;">"Be still, and know that I am God."</p>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
           <button class="btn btn-accent" data-timer-type="oracao" data-minutes="5"><i class="ph-bold ph-hands-praying"></i> 5m</button>
           <button class="btn btn-primary" data-timer-type="devocional" data-minutes="10"><i class="ph-bold ph-book-open"></i> 10m</button>
        </div>
        <button class="btn btn-danger" style="width:100%; margin-top:12px;" id="btn-stop-timer">Stop Moment</button>
      </div>
    </section>

    <!-- REFLECTIONS -->
    <section class="section" id="section-reflections">
      <div class="card">
        <div class="card-header"><div class="card-title">Spiritual Journal</div></div>
        <textarea id="reflection-input" placeholder="What did God speak to you today?" style="min-height:140px; margin-top:10px;"></textarea>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:16px;">
          <span style="font-size:0.8rem; color:var(--success); font-weight:700;">+10 XP</span>
          <button class="btn btn-primary" id="btn-save-reflection">Save</button>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">History</div></div>
        <div id="reflections-list"></div>
      </div>
    </section>

    <!-- PROFILE -->
    <section class="section" id="section-profile">
      <div class="card">
        <div class="card-header"><div class="card-title">Your Data</div></div>
        <div class="stats-grid" style="grid-template-columns: 1fr; text-align:left; gap:0;">
          <div style="padding:16px 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between;">
            <span style="color:var(--text-muted)">Status</span> <strong id="profile-estado">â€”</strong>
          </div>
          <div style="padding:16px 0; display:flex; justify-content:space-between;">
            <span style="color:var(--text-muted)">Focus</span> <strong id="profile-foco">â€”</strong>
          </div>
        </div>
        <div id="medals-tags" class="chip-group" style="margin-top:16px;"></div>
      </div>
      <div class="card" style="border-color:var(--danger-bg);">
        <button class="btn btn-danger" style="width:100%" id="btn-reset-data">Reset All Data</button>
      </div>
    </section>
  </main>

  <!-- MODAL ONBOARDING -->
  <div class="modal-backdrop" id="onboarding-backdrop">
    <div class="modal">
      <h2 style="font-family:'Outfit'; font-weight:700; margin-bottom:8px;">Adjust Path</h2>
      <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:20px;">Customize your experience.</p>
      
      <div style="margin-bottom:20px;">
        <label style="font-weight:600; font-size:0.9rem;">Spiritual life today?</label>
        <div class="chip-group" id="chips-estado">
          <button class="chip" data-value="Struggling">Struggling</button>
          <button class="chip" data-value="Average">Average</button>
          <button class="chip" data-value="Good">Good</button>
        </div>
      </div>
      
      <div style="margin-bottom:20px;">
        <label style="font-weight:600; font-size:0.9rem;">Available time?</label>
        <div class="chip-group" id="chips-tempo">
          <button class="chip" data-value="3 minutes">3 min</button>
          <button class="chip" data-value="10 minutes">10 min</button>
          <button class="chip" data-value="15 minutes or more">15+ min</button>
        </div>
      </div>

      <div style="margin-bottom:24px;">
        <label style="font-weight:600; font-size:0.9rem;">Main focus?</label>
        <div class="chip-group" id="chips-foco">
          <button class="chip" data-value="Prayer">Prayer</button>
          <button class="chip" data-value="Bible Reading">Bible</button>
          <button class="chip" data-value="Mixed">All</button>
        </div>
      </div>
      
      <div style="display:flex; gap:10px;">
        <button class="btn btn-secondary" style="flex:1" id="btn-cancel-onboarding">Cancel</button>
        <button class="btn btn-primary" style="flex:1" id="btn-save-onboarding">Save</button>
      </div>
    </div>
  </div>

  <!-- MODAL SHARE -->
  <div class="modal-backdrop" id="share-backdrop">
    <div class="modal" style="text-align:center;">
      <div style="font-size:4rem; margin-bottom:10px; animation:bounce 2s infinite">ðŸ”¥</div>
      <h2 style="font-family:'Outfit'; font-weight:700;">Congratulations!</h2>
      <p style="color:var(--text-muted); margin:10px 0 24px;">You completed everything for today. <br>Streak: <strong id="share-streak-val" style="color:var(--primary)">0</strong> days.</p>
      <button class="btn btn-whatsapp" style="width:100%" onclick="shareProgress()">Share Victory</button>
      <button class="btn btn-secondary" style="width:100%; margin-top:10px;" onclick="closeShareModal()">Close</button>
    </div>
  </div>

  <script>
    // --- THEME LOGIC ---
    const themeBtn = document.getElementById('theme-toggle');
    const htmlEl = document.documentElement;
    const themeIcon = themeBtn.querySelector('i');

    function toggleTheme() {
      const isLight = htmlEl.getAttribute('data-theme') === 'light';
      const newTheme = isLight ? 'dark' : 'light';
      htmlEl.setAttribute('data-theme', newTheme);
      localStorage.setItem('faithTheme', newTheme);
      themeIcon.className = newTheme === 'light' ? 'ph ph-moon' : 'ph ph-sun';
    }
    themeBtn.addEventListener('click', toggleTheme);
    
    const savedTheme = localStorage.getItem('faithTheme') || 'dark';
    htmlEl.setAttribute('data-theme', savedTheme);
    themeIcon.className = savedTheme === 'light' ? 'ph ph-moon' : 'ph ph-sun';

    // --- APP LOGIC ---
    const STORAGE_KEY = "faithJourney_V1_EN";
    
    const LEVELS = [
      { name: "Pilgrim", xp: 0 }, { name: "Disciple", xp: 100 },
      { name: "Watchman", xp: 500 }, { name: "Warrior", xp: 1000 },
      { name: "Missionary", xp: 2500 }
    ];

    const DAILY_MISSIONS = [
      { id: "versiculo", title: "Verse of the Day", desc: "Read and meditate.", xp: 10 },
      { id: "reflexao", title: "Reflective Pause", desc: "Think on eternity (1 min).", xp: 15 },
      { id: "oracao", title: "Prayer", desc: "Talk to God.", xp: 20 },
      { id: "leitura", title: "Bible Reading", desc: "Solid spiritual food.", xp: 15 },
      { id: "gratidao", title: "Gratitude", desc: "Express thanks.", xp: 10 }
    ];

    let state = {
      xp: 0, streak: 0, lastActive: null,
      profile: { estado: null, foco: null },
      missions: {}, reflections: {}, purpose: ""
    };

    function init() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) state = { ...state, ...JSON.parse(raw) };
      renderAll();
      if(!state.profile.foco) setTimeout(() => document.getElementById("onboarding-backdrop").classList.add("show"), 800);
    }

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function getToday() { return new Date().toISOString().slice(0,10); }

    function addXP(amount) {
      state.xp += amount;
      const today = getToday();
      if(state.lastActive !== today) {
        const diff = state.lastActive ? (new Date(today) - new Date(state.lastActive))/(1000*60*60*24) : 1;
        if(diff >= 1 && diff < 2) state.streak++;
        else if(diff >= 2) state.streak = 1;
        else if(!state.lastActive) state.streak = 1;
        state.lastActive = today;
      }
      save(); renderAll();
    }

    function renderAll() {
      const today = getToday();
      
      // Stats
      document.getElementById("xp-total").textContent = state.xp;
      document.getElementById("streak-days").textContent = state.streak;
      
      // Level
      let lvl = LEVELS[0], next = null;
      LEVELS.forEach(l => { if(state.xp >= l.xp) lvl = l; });
      next = LEVELS[LEVELS.indexOf(lvl)+1];
      
      document.getElementById("level-name").textContent = lvl.name;
      document.getElementById("header-level").textContent = LEVELS.indexOf(lvl)+1;
      
      if(next) {
        const pct = Math.min(100, ((state.xp - lvl.xp) / (next.xp - lvl.xp))*100);
        document.getElementById("progress-fill").style.width = pct + "%";
        document.getElementById("next-level-label").textContent = `${Math.floor(state.xp - lvl.xp)}/${next.xp - lvl.xp}`;
      } else {
        document.getElementById("progress-fill").style.width = "100%";
        document.getElementById("next-level-label").textContent = "Max";
      }

      // Missions
      const list = document.getElementById("missions-list");
      list.innerHTML = "";
      const done = state.missions[today] || {};
      
      DAILY_MISSIONS.forEach(m => {
        const isDone = !!done[m.id];
        const div = document.createElement("div");
        div.className = "mission";
        div.innerHTML = `
          <div>
            <div style="font-weight:700; font-size:0.9rem;">${m.title}</div>
            <div style="font-size:0.75rem; color:var(--text-muted);">${m.desc}</div>
          </div>
          <div class="btn-check ${isDone ? 'completed':''}">
            ${isDone ? '<i class="ph-bold ph-check"></i>' : `<span style="font-size:0.65rem; color:var(--text-muted); font-weight:700;">+${m.xp}</span>`}
          </div>
        `;
        if(!isDone) div.onclick = () => {
          if(!state.missions[today]) state.missions[today] = {};
          state.missions[today][m.id] = true;
          addXP(m.xp);
          renderAll();
          if(Object.keys(state.missions[today]).length === DAILY_MISSIONS.length) {
            document.getElementById("share-streak-val").textContent = state.streak;
            document.getElementById("share-backdrop").classList.add("show");
          }
        };
        list.appendChild(div);
      });

      document.getElementById("missions-today").textContent = Object.keys(done).length + "/" + DAILY_MISSIONS.length;
      
      // Reflections
      const rList = document.getElementById("reflections-list");
      rList.innerHTML = "";
      const dates = Object.keys(state.reflections).sort().reverse();
      document.getElementById("reflections-count").textContent = dates.length;
      
      if(dates.length === 0) rList.innerHTML = "<div style='text-align:center; font-size:0.8rem; color:var(--text-muted); padding:10px;'>No entries yet.</div>";
      
      dates.forEach(d => {
        const item = document.createElement("div");
        item.style.padding = "14px"; item.style.background = "var(--bg-subtle)"; 
        item.style.borderRadius = "12px"; item.style.marginBottom = "8px";
        
        // Date formatting in English (MM/DD/YYYY)
        const dateObj = new Date(d);
        const dateStr = dateObj.toLocaleDateString("en-US", { month: 'short', day: 'numeric', year: 'numeric' });

        item.innerHTML = `<div style="font-size:0.7rem; font-weight:700; color:var(--primary); margin-bottom:4px;">${dateStr}</div><div style="font-size:0.95rem; line-height:1.5;">${state.reflections[d]}</div>`;
        rList.appendChild(item);
      });

      // Profile
      document.getElementById("profile-estado").textContent = state.profile.estado || "â€”";
      document.getElementById("profile-foco").textContent = state.profile.foco || "â€”";
      
      const sugg = document.getElementById("today-suggestion");
      const f = state.profile.foco;
      if(f === "Prayer") sugg.textContent = "Set aside quality time in secret today.";
      else if(f === "Bible Reading") sugg.textContent = "Read Psalms for comfort or Proverbs for wisdom.";
      else sugg.textContent = "Balance the Word and Prayer in your day.";
    }

    // Actions
    document.querySelectorAll(".nav-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        window.scrollTo({top:0, behavior:'smooth'});
        document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
        document.getElementById("section-" + btn.dataset.section).classList.add("active");
      });
    });

    document.getElementById("btn-save-reflection").onclick = () => {
      const val = document.getElementById("reflection-input").value.trim();
      if(!val) return;
      state.reflections[getToday()] = val;
      addXP(10);
      document.getElementById("reflection-input").value = "";
      alert("Saved (+10 XP)!");
    };

    document.getElementById("btn-save-purpose").onclick = () => {
      state.purpose = document.getElementById("purpose-notes").value;
      save(); alert("Purpose saved!");
    };

    document.getElementById("btn-reset-data").onclick = () => {
      if(confirm("Are you sure? This will delete all progress.")) { localStorage.removeItem(STORAGE_KEY); location.reload(); }
    };

    let timerInt;
    document.querySelectorAll("[data-timer-type]").forEach(btn => {
      btn.onclick = () => {
        if(timerInt) clearInterval(timerInt);
        let sec = btn.dataset.minutes * 60;
        const display = document.getElementById("timer-display");
        const status = document.getElementById("timer-status-pill");
        status.textContent = "Running..."; status.style.color = "var(--primary)";
        
        timerInt = setInterval(() => {
          sec--;
          display.textContent = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
          if(sec<=0) { 
            clearInterval(timerInt); 
            addXP(btn.dataset.timerType === 'oracao' ? 20 : 15); 
            status.textContent = "Done!"; status.style.color = "var(--success)";
            alert("Timer finished! XP Earned.");
          }
        }, 1000);
      };
    });
    document.getElementById("btn-stop-timer").onclick = () => {
       if(timerInt) clearInterval(timerInt);
       document.getElementById("timer-display").textContent = "00:00";
       document.getElementById("timer-status-pill").textContent = "Idle";
    };

    const modal = document.getElementById("onboarding-backdrop");
    const chips = (id) => document.querySelectorAll(`#${id} .chip`).forEach(c => c.onclick = () => {
      document.querySelectorAll(`#${id} .chip`).forEach(x => x.classList.remove("selected"));
      c.classList.add("selected");
    });
    chips("chips-estado"); chips("chips-tempo"); chips("chips-foco");

    document.getElementById("btn-open-onboarding").onclick = () => modal.classList.add("show");
    document.getElementById("btn-cancel-onboarding").onclick = () => modal.classList.remove("show");
    document.getElementById("btn-save-onboarding").onclick = () => {
      const val = (id) => document.querySelector(`#${id} .chip.selected`)?.dataset.value;
      state.profile = { estado: val("chips-estado"), tempo: val("chips-tempo"), foco: val("chips-foco") };
      save(); renderAll(); modal.classList.remove("show");
    };

    function closeShareModal() { document.getElementById("share-backdrop").classList.remove("show"); }
    function shareProgress() {
      const text = `ðŸ”¥ Faith Journey: ${state.streak} day streak with God!`;
      window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
    }

    init();
  </script>
</body>
</html>
